name: Competitor Data Collection

on:
    schedule:
        # Run daily at 6 PM EST (after market close)
        - cron: "0 23 * * 1-5"
    workflow_dispatch: # Allow manual trigger

jobs:
    collect-competitor-data:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.9"

            - name: Install dependencies
              run: |
                  pip install yfinance requests pandas numpy scikit-learn

            - name: Run Competitor Data Collector
              run: |
                  python competitor_data_collector.py

            - name: Safe commit and push competitor data
                run: |
                    git config --local user.email "action@github.com"
                    git config --local user.name "GitHub Action"

                    # Use safe update script to prevent merge conflicts
                    echo "🔒 Using safe update mechanism to prevent merge conflicts..."
                    
                    # Create a simple lock file to prevent concurrent updates
                    LOCK_FILE="data/.update_lock"
                    MAX_WAIT=30
                    WAIT_TIME=0
                    
                    # Wait for lock to be released
                    while [ -f "$LOCK_FILE" ] && [ $WAIT_TIME -lt $MAX_WAIT ]; do
                        echo "⏳ Waiting for lock to be released... (${WAIT_TIME}s)"
                        sleep 1
                        WAIT_TIME=$((WAIT_TIME + 1))
                    done
                    
                    if [ -f "$LOCK_FILE" ]; then
                        echo "❌ Could not acquire lock after $MAX_WAIT seconds"
                        exit 1
                    fi
                    
                    # Create lock file
                    echo "Locked by competitor data collection at $(date)" > "$LOCK_FILE"
                    echo "🔒 Lock acquired for competitor data updates"
                    
                    # Add competitor data files
                    git add data/competitor_performance.json data/competitor_performance_comparison.json

                    # Check if there are changes
                    if git diff --staged --quiet; then
                        echo "No competitor data changes to commit"
                    else
                        git commit -m "📊 Update competitor data - $(date)"
                        git push
                    fi
                    
                    # Remove lock file
                    rm -f "$LOCK_FILE"
                    echo "🔓 Lock released for competitor data updates"
