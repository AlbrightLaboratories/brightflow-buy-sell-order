name: Pull Data from Sandbox

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:

jobs:
  pull-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download Data from Sandbox
      run: |
        echo "ğŸ“¥ Downloading data from sandbox..."
        mkdir -p data

        curl -s -o data/transactions.json \
          https://raw.githubusercontent.com/AlbrightLaboratories/brightflow-sandbox/data/data/transactions.json

        curl -s -o data/performance.json \
          https://raw.githubusercontent.com/AlbrightLaboratories/brightflow-sandbox/data/data/performance.json

        curl -s -o data/recommendations.json \
          https://raw.githubusercontent.com/AlbrightLaboratories/brightflow-sandbox/data/data/recommendations.json

        curl -s -o data/hourly_market_data.json \
          https://raw.githubusercontent.com/AlbrightLaboratories/brightflow-sandbox/data/data/hourly_market_data.json

        echo "âœ… Downloaded all data files"

    - name: Validate JSON
      run: |
        python3 -m json.tool data/transactions.json > /dev/null && echo "âœ… transactions.json valid"
        python3 -m json.tool data/performance.json > /dev/null && echo "âœ… performance.json valid"
        python3 -m json.tool data/recommendations.json > /dev/null && echo "âœ… recommendations.json valid"
        python3 -m json.tool data/hourly_market_data.json > /dev/null && echo "âœ… hourly_market_data.json valid"

    - name: Check for Changes
      id: changes
      run: |
        git add data/*.json
        if git diff --cached --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š No changes detected"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Changes detected"
        fi

    - name: Commit and Push
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config user.name "BrightFlow Data Bot"
        git config user.email "data-bot@brightflow.ai"
        git add data/*.json
        git commit -m "chore: update trading data $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
        git push

    - name: Success
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "âœ… Data synced at $(date)"
        echo "ğŸŒ Dashboard will update automatically"

    - name: No Changes
      if: steps.changes.outputs.changed == 'false'
      run: echo "â­ï¸  No updates needed"
